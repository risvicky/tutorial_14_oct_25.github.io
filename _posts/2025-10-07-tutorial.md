---
title: "Simple Ionic Solution"
date: 2025-10-07
author: "Risnita Vicky Listyarini"
---

The objective of this tutorial is to perform molecular dynamics simulation using open-source software GROMACS to study the system consist of water with sodium (Na<sup>+</sup>) and nitrate (NO<sub>3</sub><sup>-</sup>) ions.

The tutorial will guide you through the steps of setting up the simulation, adding species to the system and solvating it with water.
It will also introduce key points in MD simulation e.g. energy minimisation,thermostating, and both *NVT* and *NPT* equilibration steps.

## Molecular Dynamics Simulation Steps
The following steps will be covered in this tutorial:
1. **Preparation of the System**: Setting up the initial configuration of NaNO<sub>3</sub> in a water box.
2. **Setting Up the Simulation Parameters**: Defining the force field and simulation parameters.
3. **Energy Minimisation**: Performing energy minimisation to relax the system.
4. **Equilibration**: Running equilibration steps under *NVT* and *NPT* ensembles.
5. **Production Run**: Conducting the main simulation to collect data for analysis.
6. **Analysis**: Analysing the results to understand the solvation of NaNO<sub>3</sub> in water.

## Setting Up GROMACS environment
Make sure you can run GROMACS commands in your terminal. Load GROMACS by typing the following command in your terminal:
   ```bash
   module load gromacs/intel-2022.2/2022.1-single
    gmx --version
    gmx
   ```
   If this result appears,
   ```bash
    gmx
    -bash: gmx: command not found
   ```
   depending to the access node that your account has, for teaching node
   ```bash
    source /usr/local/gromacs/bin/GMXRC
    gmx
   ```
   To get more information about GROMACS installation and user guide, please visit [GROMACS website](https://manual.gromacs.org/current/install-guide/index.html).[1]

### Setting Up Molecular Visualisation Software
To visualise the molecular structure and simulation results, we can use program like Visual Molecular Dynamics (VMD) or PyMol.
We will use VMD program. [VMD](https://www.ks.uiuc.edu/Development/Download/download.cgi?PackageName=VMD) is available to non-commercial users under a distribution-specific license which permits both use of the program and modification of its source code, at no charge. You just have to register your email to download the program.

To load the module,
   ```bash
    module load vmd/1.9.4
    vmd
   ```
If you are using ThinLinc, you need to do,
   ```bash
    module load vmd/1.9.4
    vglrun vmd
   ```

## 1. Preparation of the System
Let us create a new directory for MD simulation files.
   ```bash
   mkdir nano3_solution
   cd nano3_solution
   ```
We will make an empty box by creating an empty file called `empty.gro`.
   ```bash
   touch empty.gro
   nedit empty.gro
   ```
`touch` command is used to create a new empty file, while `nedit` command opens a text editor with a standard GUI (graphical user interface) in Linux.
You can also open and edit the file using your favourite text editor in Linux.

Then, we will create a box with a size of 3 nm x 3 nm x 3 nm by copying and pasting the following lines into `empty.gro`.
   ```
    Cubic box
    0
    3.00000   3.00000   3.00000
   ```
The first line, `Cubic box`, is a comment line; the second line, `0`, indicates that there are no atoms in the box; and the third line specifies the dimensions of the box in nanometers, 10 nm in each direction (x, y, z). This ***.gro*** is written in [Gromos87](https://manual.gromacs.org/archive/5.0.4/online/gro.html) format. 

Next, we will add NO<sub>3</sub><sup>-</sup> ions to the box. Within the same folder as `empty.gro`, make a new file called `no3.gro` and copy the following lines into it.
   ```
NO3 ion
    4
    1NO3    N1    1   0.000   0.000   0.000
    1NO3    O1    2   0.120   0.120   0.000
    1NO3    O2    3  -0.120   0.120   0.000
    1NO3    O3    4   0.000  -0.140   0.000
   1.00000   1.00000   1.00000
   ```
It contains 4 atoms named `N1`, `O1`, `O2`, and `O3`all grouped under the residue name `NO3`. 

Using the `gmx insert-molecules` command to add 10 NO<sub>3</sub><sup>-</sup> ions to the empty box, type the following command in your terminal:

   ```bash
   gmx insert-molecules -ci no3.gro -f empty.gro -o conf.gro -nmol 10 -radius 0.5
   ```
The `insert-molecule` command inserts molecules into a simulation box. The `-ci` flag specifies the input file containing the molecule to be inserted, which is `no3.gro` in this case. The `-f` flag indicates the input file for the box, which is `empty.gro`. The `-o` flag specifies the output file name, which will be `conf.gro`, containing the new configuration with the inserted ions. The `-nmol` flag indicates the number of ions to insert (10 NO<sub>3</sub><sup>-</sup> ions). The `-radius` flag sets the minimum distance between inserted molecules to avoid overlaps (set to 0.5 nm) 
See documentation of [insert-molecule](https://manual.gromacs.org/2025.1/onlinehelp/gmx-insert-molecules.html) command for more information. 

If the insertions were sucessful, the output printed in the terminal should look like this.
```
Added 10 molecules (out of 10 requested)
Writing generated configuration to conf.gro
```

The generated **conf.gro** should contains 40 atoms corresponding to 10 ions.
```
Cubic box
   40
    1NO3     N1    1   0.714   1.584   2.324
    1NO3     O1    2   0.848   1.578   2.428
    1NO3     O2    3   0.748   1.747   2.289
    1NO3     O3    4   0.616   1.493   2.283
    (...)
3.00000   3.00000   3.00000
```
The explanation of each row:
- the residue ID, with all 4 atoms from the same ion NO<sub>3</sub><sup>-</sup> sharing the same residue ID
- the residue name (NO3)
- the atom name (N1, O1, O2, O3) 
- the atom ID (1 to 40)
- the atom position (*x*, *y*, *z* coordinates in nm)

Make a new file called `na.gro` and copy the following lines into it.
   ```
Na+ ion
1
    1   Na   Na1   1   0.000   1.000   0.000
   1.00000   1.00000   1.00000
   ```

## üß© Exercise

<div class="exercise-box">
  <div class="exercise-header">Exercise</div>
  <p>
    Use the `insert-molecules` command to add 10 Na<sup>+</sup> to the same `conf.gro` file with radius of 0.5 nm from each other.
  </p>

  <details class="solution-box">
    <summary>üëÅÔ∏è Solution</summary>
    <pre><code>gmx insert-molecules -ci na.gro -f conf.gro -o conf.gro -nmol 10 -radius 0.5</code></pre>
  </details>
</div>

<style>
.exercise-box {
  border: 2px solid #f0c27b;
  background-color: #fff8e1;
  border-radius: 10px;
  padding: 16px;
  margin: 20px 0;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.exercise-header {
  background-color: #f3cd88;
  color: #4a3a1f;
  font-weight: bold;
  padding: 6px 10px;
  border-radius: 6px;
  margin-bottom: 10px;
  font-size: 1.1em;
}

.solution-box summary {
  background-color: #f0ede3;
  padding: 8px 12px;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
}

.solution-box[open] summary {
  background-color: #e2dcc4;
}

.solution-box pre {
  background-color: #f6f4eb;
  padding: 10px;
  border-radius: 6px;
  margin-top: 8px;
  overflow-x: auto;
}
</style>

Finally, we will add H<sub>2</sub>O molecules to the box.
Download the [h2o.gro](/file/h2o.gro) template for H<sub>2</sub>O molecule and save it in the same folder.

## üß© Exercise

<div class="exercise-box">
  <div class="exercise-header">Exercise</div>
  <p>
    Use the `insert-molecules` command to add 800 H<sub>2</sub>O molecule to the same `conf.gro` file from previous step with radius of 0.14 nm from each other.
  </p>

  <details class="solution-box">
    <summary>üëÅÔ∏è Solution</summary>
    <pre><code>gmx insert-molecules -ci h2o.gro -f conf.gro -o conf.gro -nmol 800 -radius 0.14</code></pre>
  </details>
</div>

<style>
.exercise-box {
  border: 2px solid #f0c27b;
  background-color: #fff8e1;
  border-radius: 10px;
  padding: 16px;
  margin: 20px 0;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.exercise-header {
  background-color: #f3cd88;
  color: #4a3a1f;
  font-weight: bold;
  padding: 6px 10px;
  border-radius: 6px;
  margin-bottom: 10px;
  font-size: 1.1em;
}

.solution-box summary {
  background-color: #f0ede3;
  padding: 8px 12px;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
}

.solution-box[open] summary {
  background-color: #e2dcc4;
}

.solution-box pre {
  background-color: #f6f4eb;
  padding: 10px;
  border-radius: 6px;
  margin-top: 8px;
  overflow-x: auto;
}
</style>

The final **conf.gro** file contains:
   ```
Cubic box
 3250
    1NO3     N1    1   0.106   2.871   2.482
    1NO3     O1    2   0.070   2.771   2.615
    1NO3     O2    3   0.058   2.747   2.376
    1NO3     O3    4   0.154   3.001   2.467
    2NO3     N1    5   2.555   3.081   0.817
    2NO3     O1    6   2.413   3.115   0.730
    2NO3     O2    7   2.473   3.112   0.962
    2NO3     O3    8   2.685   3.043   0.783
    (...)
  818Sol    MW1 3242   1.779   0.040   3.332
  819Sol    OW1 3243   0.475   2.418   2.428
  819Sol    HW1 3244   0.477   2.506   2.490
  819Sol    HW2 3245   0.405   2.420   2.347
  819Sol    MW1 3246   0.475   2.418   2.428
  820Sol    OW1 3247   1.729   1.927   2.959
  820Sol    HW1 3248   1.713   1.921   3.065
  820Sol    HW2 3249   1.796   1.855   2.917
  820Sol    MW1 3250   1.729   1.927   2.959
   3.50000   3.50000   3.50000
   ```

The generated conf.gro file can be visualized using VMD by typing in the terminal:
   ```bash
  vmd conf.gro
   ```

![nano3](/figure/nano3.png){: width="500" height="auto" .center}

The water molecules and ions have been randomly inserted into the space, making them look unrealistic. This will be corrected during the energy minimisation step, when the residues will be moved and rotated according to the forces exerted by their surroundings.  

## 2. **Setting Up the Simulation Parameters**

Parameters for the interactions between different atoms and molecules are provides in the topology file (**.top** and **.itp**). These parameters include both bonded and non-bonded interactions.

The [topol.top](/file/topol.top) must be in the same folder as the **conf.gro** file. The **topol.top** file contains:
```
#include "ff/forcefield.itp"
#include "ff/h2o.itp"
#include "ff/na.itp"
#include "ff/no3.itp"

[ System ]
NaNO3 solution

[ Molecules ]
NO3 ..fill the blank..
Na ..fill the blank..
SOL ..fill the blank..
```

The meaning of the first four lines are to include the parameters in four separated files (**forcefield.itp**, **h2o.itp**, **na.itp**, **no3.itp**) located in **ff/** folder. 

<div class="exercise-box">
  <div class="exercise-header">Exercise</div>
  <p>
    Change ..fill the blank.. inside the `topol.top` file to the correct values
  </p>

  <details class="solution-box">
    <summary>üëÅÔ∏è Solution</summary>
    <pre><code> 10, 10, 800</code></pre>
  </details>
</div>

Create a folder named **ff/** next to the **conf.gro** and the topol.top files, and copy the four following files into it:

- [forcefield.itp](/file/forcefield.itp)
- [h2o.itp](/file/h2o.itp)
- [na.itp](/file/na.itp)
- [no3.itp](/file/no3.itp)

**forcefield.itp** contains the information of combination rules *comb-rule 2* that corresponds to the [Lorentz-Berthelot](https://en.wikipedia.org/wiki/Combining_rules) rule.
```
[ defaults ]
; nbfunc  comb-rule  gen-pairs  fudgeLJ  fudgeQQ
  1       2          no         1.0      0.833
```


## 3. **Energy Minimisation**

From the configuration of the .gro file, it can be seen that the molecules and ions are in an unrealistic configuration. Thus, performing a MD simulation directly would cause the system to explode, as the atoms would experience huge forces.

The energy minimisation step will bring the system into a more favourable state by moving the atoms until the forces between them are reasonable.

Make a blank file with the name of **min.mdp** and copy the following lines into **min.mdp**
```
integrator = steep
nsteps = 5000
nstxout = 10
```

`steep` is the integrator algorithm refer to [steepest-descent](https://manual.gromacs.org/current/reference-manual/algorithms/energy-minimization.html). The atoms are moved in the direction of the largest forces until one of the stopping criteria is reached.

`nstep` specifies the maximum number of step and `nstxout` refers to print the atom positions every 10 steps.  
The trajectory is generayed in a **.trr** file that can be visualised using VMD.

Run the input script using GROMACS. From the terminal, type:
   ```bash
  gmx grompp -f min.mdp -c conf.gro -o min -pp min -po min
  gmx mdrun -v -deffnm min
   ```

`grompp` command is called to preprocess the files for the simulation. The flags `-f` and `-c` specify the input (**min.mdp**) file and the initial configuration (**.gro**) file. While `-o`, `-pp` and `-po` are used to specify the names of outputs that will be produced during the run.

`mdrun` command calls the engine to perform the computation on the preprocessed files. `-v` flag ensures that information about the run is also printed in the terminal. 

```
Steepest Descents converged to machine precision in 2495 steps,
but did not reach the requested Fmax < 10.
Potential Energy  = -4.6779059e+04
Maximum force     =  1.9323999e+02 on atom 1688
Norm of force     =  4.1634869e+01
```

This message can be ignored as long as the final potential energy is large and negative.

```
Step=    0, Dmax= 1.0e-02 nm, Epot=  1.03702e+04 Fmax= 2.76809e+04, atom= 5
(...)
Step= 2494, Dmax= 1.8e-06 nm, Epot= -4.67791e+04 Fmax= 2.84188e+02, atom= 2019
```
The maximum force has been reduced to 284 kJ/mol during the energy minimisation and the following 7 files must have been created: **min.edr**, **min.gro**, **min.log**, **min.mdp**, **min.top**, **min.tpr**, **min.trr**.

## üß© Exercise

<div class="exercise-box">
  <div class="exercise-header">Exercise</div>
  <p>
    The trajectory can be visualised by loading the topology and trajectory files. What should we type into the terminal?
  </p>

  <details class="solution-box">
    <summary>üëÅÔ∏è Solution</summary>
    <pre><code>vmd conf.gro min.trr</code></pre>
  </details>
</div>

To avoid molecules being cut by periodic boundary condition, use this command, 
```
gmx trjconv -f min.trr -s min.tpr -o min_whole.trr -pbc whole
```
select `0` as the group of choice for the output and reopen the modified trajectory using VMD.

```
vmd conf.gro min_whole.trr
```


![no3_ion](/figure/no3_h2o.png){: width="auto" height="auto" .center}
![na_ion](/figure/na.png){: width="auto" height="auto" .center}

The change in potential energy can be extracted during minimisation run by typing this command
```
gmx energy -f min.edr -o min_pe.xvg
```
Choose `Potential` by typing `5` and press `Enter` twice.
The energy value is taken from **min.edr** file and being saved as **min_pe.xvg**

To visualise the result, we can use Grace/Xmgrace program by typing
```
xmgrace min_pe.xvg
```
![min_pe](/figure/min_pe.png){: width="auto" height="auto" .center}

The system should be stable enough for the MD simulation.

## 4. **Equilibration**
#### *NVT* ensemble

In *NVT* ensemble,  the number of atoms (*N*) and the volume (*V*) are maintained fixed, and the temperature of the system (*T*) is adjusted using a thermostat

For *NVT* simulation, we will create a new input script called **nvt.mdp** and copy the following lines into it,
```
; nvt.mdp adapted from: https://gromacstutorials.github.io/sphinx/build/html/tutorials/tutorial1/bulk-solution.html
; Intergrator, timestep, and total run time
integrator = md           ; A leap-frog algorithm for integrating Newton‚Äôs equations of motion.
nsteps = 20000            ; Simulation will run for 20000 steps
dt = 0.001                ; with timestep of 0.001  ps

comm_mode = linear        ; Remove center of mass translational velocity
comm_grps = system

; Van der Waals interactions
gen-vel = yes             ; give initial velocity to atoms
gen-temp = 360            ; desired temperatur of 360 K

; Neighbor searching
cutoff-scheme = Verlet    ; Generate a pair list with buffering
nstlist = 10 
ns_type = grid

; Logs and outputs
nstlog = 100              ; print information in the log file every 100 steps
nstenergy = 100           ; print information in the energy file .edr every 100 steps
nstxout-compressed = 1000 ; Output to md.log every 1000 steps or every 1 ps

; Van der Waals interactions
vdw-type = Cut-off        ; Define type of short-ranged interaction
rvdw = 1.0                ; Define short-ranged cutoff as 1 nm

; Coulombic interactions
coulombtype = pme         ; Define type of long-ranged interactions with particle-mesh ewald (SPME) electrostatics
fourierspacing = 0.1      ; with Fourier spacing of 0.1 nm
pme-order = 4             ; and cut-off of 1 nm
rcoulomb = 1.0            ; Define long-ranged cutoff as 1nm

; Bond constraints
constraint-algorithm = lincs  ; LINCS algorithm 
constraints = hbonds          ; to constrain the hydrogen bonds 
continuation = no

; Thermostat
tcoupl = v-rescale        ; Define type of thermostat (a Berendsen thermostat with an additional stochastic term)
ld-seed = 48456
tc-grps = Water non-Water ; the thermostat is applied to the entire system 
tau-t = 0.5 0.5   ; damping constant for the thermostat (two separate T baths for the water molecules and the ions/non-water)
ref-t = 360 360           ; the same T for two groupswith T of 360 K
```

Computing the long-range Coulomb interactions is necessary, because electrostatic forces between charged particles decay slowly, as the inverse of the square of the distance between them $$1/r^2$$. 
The cut-off *rcoulomb* separates the short-range interactions from the long-range interactions. 

Run the *NVT* simulation using the **nvt.mdp** by typing
```
gmx grompp -f nvt.mdp -c min.gro -o nvt -pp nvt -po nvt

```
If there is a message
```
Fatal error:
Too many warnings (1).
```
rerun the command by typing
```
gmx grompp -f nvt.mdp -c min.gro -o nvt -pp nvt -po nvt -maxwarn 1
gmx mdrun -v -deffnm nvt
```
We use **min.gro** from the previous energy minimisation step as a starting point.

The temperature should reach 360 K and can be checked using the command.
```
gmx energy -f nvt.edr -o nvt-T.xvg
```
choose `10` for temperature and press `Enter` twice. You can visualise the evolution of T using Grace.

![nvt](/figure/nvt-t.png){: width="auto" height="auto" .center}

The temperature start from 360 K but increase quickly because of interaction between neighbour species.
Thermostat helps to reach the desired T of 360 K after picoseconds by removing the extra energy from the system. 

#### *NPT* ensemble

For *NPT* simulation, we will create a new input script called **npt.mdp** and copy the following lines into it,

```
; npt.mdp adapted from: https://gromacstutorials.github.io/sphinx/build/html/tutorials/tutorial1/bulk-solution.html
; Intergrator, timestep, and total run time
integrator = md           ; A leap-frog algorithm for integrating Newton‚Äôs equations of motion.
nsteps = 80000            ; Simulation will run for 80000 steps
dt = 0.001                ; with timestep of 0.001  ps

comm_mode = linear        ; Remove center of mass translational velocity
comm_grps = system

; Neighbor searching
cutoff-scheme = Verlet    ; Generate a pair list with buffering
nstlist = 10 
ns_type = grid

; Logs and outputs
nstlog = 100              ; print information in the log file every 100 steps
nstenergy = 100           ; print information in the energy file .edr every 100 steps
nstxout-compressed = 1000 ; Output to md.log every 1000 steps or every 1 ps

; Van der Waals interactions
vdw-type = Cut-off        ; Define type of short-ranged interaction
rvdw = 1.0                ; Define short-ranged cutoff as 1 nm

; Coulombic interactions
coulombtype = pme         ; Define type of long-ranged interactions with particle-mesh ewald (SPME) electrostatics
fourierspacing = 0.1      ; with Fourier spacing of 0.1 nm
pme-order = 4             ; and cut-off of 1 nm
rcoulomb = 1.0            ; Define long-ranged cutoff as 1nm

; Bond constraints
constraint-algorithm = lincs  ; LINCS algorithm 
constraints = hbonds          ; to constrain the hydrogen bonds 

; Thermostat
tcoupl = v-rescale        ; Define type of thermostat (a Berendsen thermostat with an additional stochastic term)
ld-seed = 48456
tc-grps = Water non-Water ; the thermostat is applied to the entire system 
tau-t = 0.5 0.5   ; damping constant for the thermostat (two separate T baths for the water molecules and the ions/non-water)
ref-t = 360 360           ; the same T for two groupswith T of 360 K

; Barostat
pcoupl = C-rescale        ; Define the type of barostat (isotropic C-rescale pressure coupling)
Pcoupltype = isotropic    
tau_p = 1.0               ; Define pressure coupling time
ref_p = 1.0               ; Define system pressure in bars
compressibility = 4.5e-5  ; Define compressibility of system in bar^-1

```
Because the atoms already have a velocity, we remove `gen-vel` and `gen-temp` options.

Run the *NPT* simulation using the **npt.mdp** by typing
```
gmx grompp -f npt.mdp -c nvt.gro -o npt -pp npt -po npt -maxwarn 1
gmx mdrun -v -deffnm npt
```
We use **nvt.gro** from the previous *NVT* step to run *NPT* simulation.

To check the temperature, pressure and volume of the box during the NPT simulation, the `gmx energy` command can be used as follows:
```
gmx energy -f npt.edr -o npt-T.xvg
gmx energy -f npt.edr -o npt-p.xvg
gmx energy -f npt.edr -o npt-rho.xvg
```
choose `10`, `11` and `16` respectively and press `Enter` twice. 

You can visualise the evolution of temperature, pressure and volume of the box using Grace.

![npt_T](/figure/npt_T.png){: width="auto" height="auto" .center}
![npt_P](/figure/npt_P.png){: width="auto" height="auto" .center}
![npt_rho](/figure/npt_rho.png){: width="auto" height="auto" .center}

## 5. **Production Run**


## 6. **Analysis**



## Feedback

Please click this link to fill the feedback from today's tutorial.
[Word Cloud](https://www.menti.com/alxysgfpskwq)
or use the QR code below:
![nano3](/figure/qr.png)

References:
1. GROMACS User Manual, https://manual.gromacs.org/current/install-guide/index.html
